<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Memories</title>

<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#f8f9fa;
}

.navbar{
    background:white;
    padding:15px 30px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    box-shadow:0 2px 5px rgba(0,0,0,0.1);
}

.logo{
    font-size:22px;
    font-weight:bold;
    color:#ff6b81;
}

.avatar{
    width:35px;
    height:35px;
    min-width:35px;
    min-height:35px;
    border-radius:50%;
    object-fit:cover;
    display:block;
}

button{
    background:#ff6b81;
    color:white;
    border:none;
    padding:6px 12px;
    border-radius:20px;
    cursor:pointer;
}

input, textarea{
    padding:8px;
    border-radius:8px;
    border:1px solid #ccc;
}

#gallery{
    column-count:3;
    column-gap:15px;
    padding:20px;
}

.card{
    background:white;
    border-radius:15px;
    margin-bottom:15px;
    break-inside:avoid;
    box-shadow:0 3px 10px rgba(0,0,0,0.1);
    overflow:hidden;
}

.card img{
    width:100%;
}

.card-content{
    padding:10px;
}

.comment{
    background:#f1f2f6;
    padding:5px;
    border-radius:8px;
    margin-top:5px;
    font-size:13px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage" style="text-align:center;margin-top:100px;">
    <h2>Welcome to Memories</h2>
    <input type="text" id="username" placeholder="Username">
    <br><br>
    <input type="file" id="avatarUpload" accept="image/*">
    <br><br>
    <button onclick="register()">Enter</button>
</div>

<!-- MAIN -->
<div id="mainPage" style="display:none;">
    <div class="navbar">
        <div class="logo">Memories</div>
        <div>
            <span id="displayName"></span>
            <img id="displayAvatar" class="avatar">
            <button onclick="logout()">Logout</button>
        </div>
    </div>

    <div style="padding:20px;">
        <input type="file" id="upload" accept="image/*">
        <textarea id="description" placeholder="Write your memory..."></textarea>
        <button onclick="addPost()">Post</button>
    </div>

    <div id="gallery"></div>
</div>

<script>

// LOAD POSTS SAFE
let posts = [];
try{
    const stored = localStorage.getItem("posts");
    if(stored) posts = JSON.parse(stored);
}catch(e){
    posts = [];
}

function savePosts(){
    localStorage.setItem("posts", JSON.stringify(posts));
}

function register(){
    const username = document.getElementById("username").value.trim();
    const avatarFile = document.getElementById("avatarUpload").files[0];

    if(!username || !avatarFile){
        alert("Please enter username and choose avatar!");
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e){
        const user = {
            username: username,
            avatar: e.target.result
        };
        localStorage.setItem("currentUser", JSON.stringify(user));
        loadUser();
    };
    reader.readAsDataURL(avatarFile);
}

function loadUser(){
    const user = localStorage.getItem("currentUser");
    if(user){
        const parsed = JSON.parse(user);
        document.getElementById("loginPage").style.display="none";
        document.getElementById("mainPage").style.display="block";
        document.getElementById("displayName").innerText=parsed.username;
        document.getElementById("displayAvatar").src=parsed.avatar;
        renderPosts();
    }
}

function logout(){
    localStorage.removeItem("currentUser");
    location.reload();
}

// ===== FIXED ADD POST (AUTO COMPRESS IMAGE) =====
function addPost(){
    const file = document.getElementById("upload").files[0];
    const desc = document.getElementById("description").value;
    const user = JSON.parse(localStorage.getItem("currentUser"));

    if(!file){
        alert("Choose an image!");
        return;
    }

    const reader = new FileReader();

    reader.onload = function(e){

        const img = new Image();
        img.src = e.target.result;

        img.onload = function(){

            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");

            const maxWidth = 600;
            const scale = maxWidth / img.width;

            canvas.width = maxWidth;
            canvas.height = img.height * scale;

            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            const compressed = canvas.toDataURL("image/jpeg", 0.7);

            posts.unshift({
                id: Date.now(),
                user: user.username,
                avatar: user.avatar,
                image: compressed,
                desc: desc,
                likes: 0,
                comments: []
            });

            savePosts();
            renderPosts();
        }
    }

    reader.readAsDataURL(file);
}

function renderPosts(){
    const gallery = document.getElementById("gallery");
    gallery.innerHTML="";

    posts.forEach(post=>{
        const card=document.createElement("div");
        card.className="card";

        const img=document.createElement("img");
        img.src=post.image;

        const content=document.createElement("div");
        content.className="card-content";

        content.innerHTML=`
            <div style="display:flex;align-items:center;gap:8px;">
                <img src="${post.avatar}" class="avatar" style="flex-shrink:0;">
                <b>${post.user}</b>
            </div>
            <div>${post.desc}</div>
            <button onclick="likePost(${post.id})">❤️ ${post.likes}</button>
            <div>
                <input placeholder="Write a comment..."
                onkeypress="if(event.key==='Enter'){addComment(${post.id}, this.value); this.value='';}">
            </div>
        `;

        post.comments.forEach(c=>{
            const cm=document.createElement("div");
            cm.className="comment";
            cm.innerText=c.user+": "+c.text;
            content.appendChild(cm);
        });

        card.appendChild(img);
        card.appendChild(content);
        gallery.appendChild(card);
    });
}

function likePost(id){
    const post=posts.find(p=>p.id===id);
    if(post){
        post.likes++;
        savePosts();
        renderPosts();
    }
}

function addComment(id,text){
    if(!text) return;
    const user=JSON.parse(localStorage.getItem("currentUser"));
    const post=posts.find(p=>p.id===id);
    if(post && user){
        post.comments.push({
            user:user.username,
            text:text
        });
        savePosts();
        renderPosts();
    }
}

loadUser();

</script>

</body>
</html>

